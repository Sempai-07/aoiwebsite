---
sidebar_position: 3
---

# Plugin Manager

In this guide, we will explain how to create your own functions for `aoitelegram`.

## Why and When Do You Need This?

Since developers may not always add a particular function to the library, you can create a function yourself, which can be used not only by you but also by anyone who installs your npm package.

## How to Use

In the `PluginManager` class constructor, it's not mandatory to specify the parameter that searches for `.aoiplugin.json` files in the `node_modules` folders and moves them to the `node_modules/.aoiplugins` directory for later use in your project.

```javascript
const { AoiClient, PluginManager } = require("aoitelegram");

const loadPlugin = new PluginManager(true);
// dir: functions/
const pluginDir = loadPlugin.loadDirPlugins("./functions");
// dir: node_modules/.aoiplugins/
const pluginModules = loadPlugin.loadPlugins("path plugin", "commit");

const bot = new AoiClient({
  token: "",
  customFunction: [...pluginDir, ...pluginModules],
});
```

```javascript
const { AoiClient, PluginManager } = require("aoitelegram");

const bot = new AoiClient({
  token: "",
});

const loadPlugin = new PluginManager(true, bot);
// dir: functions/
loadPlugin.loadDirPlugins("./functions");
// dir: node_modules/.aoiplugins/
loadPlugin.loadPlugins("path plugin", "commit");
```

```javascript
const { AoiClient } = require("aoitelegram");

const bot = new AoiClient({
  token: "",
});

// array or object
bot.addFunction([]);
bot.addFunction();
```

The structure of plugins for `npm` packages should be as follows:

```
dirName
   .aoiplugin.json
```

In `aoiplugin.json`, the only parameter used is the path to the files or file that should be used:

```json
{
  "name": "./src/",
  "version": "0.1.2"
}
```

## Example of Creation

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

<Tabs>
  <TabItem value="javascript" label="JavaScript">
    <Tabs>
      <TabItem value="esm" label="ESModule">
```js
export default {
  name: "$await",
  callback: async (ctx, event, database, error) => {
    const [time = 1] = await ctx.evaluateArgs(ctx.getArgs(0, 1));
    return new Promise((res) => setTimeout(() => res(""), time * 1000));
  },
};
```
      </TabItem>
      <TabItem value="commonjs" label="Commonjs">
```js
module.exports = {
  name: "$await",
  callback: async (ctx, event, database, error) => {
    const [time = 1] = await ctx.evaluateArgs(ctx.getArgs(0, 1));
    return new Promise((res) => setTimeout(() => res(""), time * 1000));
  },
};
```
      </TabItem>
    </Tabs>
  </TabItem>
  <TabItem value="aoitelegram" label="AoiTelegram">
    <Tabs>
      <TabItem value="esm" label="ESModule">
```js
export default {
  name: "$log",
  params: ["text"],
  version: "0.1.0",
  type: "aoitelegram",
  code: `
    $onlyIf[{text}!=undefined;Error parameter]
    $print[{text}]
  `,
};
```
      </TabItem>
      <TabItem value="commonjs" label="Commonjs">
```js
module.exports = {
  name: "$log",
  params: ["text"],
  version: "0.1.0",
  type: "aoitelegram",
  code: `
    $onlyIf[{text}!=undefined;Error parameter]
    $print[{text}]
  `,
};
```
      </TabItem>
    </Tabs>
  </TabItem>
</Tabs>

## Function js

- `ctx` is the function context.
- `event` is the object passed when using a specific event.
- `database` is an object that provides database methods.
- `error` is an object for error handling.

## Ctx
```js
Context {
  fileName: string | { event: string };
  type: string;
  target: {
    type: string;
    value: string;
    child: Object[];
    pos: number;
    line: number;
  };
  localVars: Collection<string, unknown>;
  array: Collection<string, unknown>;
  object: Collection<string, unknown>;
}
```

It has the following methods:

- `argsCheck` - Check if the number of arguments is as expected.
  - `amount` - Amount of arguments required.
  - `event` - Event object.

- `getArgs` - Get arguments from `start` up to `end`.
  - `start` - The start index.
  - `end` - Amount of arguments to be returned.

- `evaluateArgs` - Evaluate and run provided arguments.
  - `args` - Arguments to run.

- `getEvaluateArgs` - Retrieve and evaluate arguments from the `start` index up to a specified `end` count.
  - `start` - The start index.
  - `end` - Amount of arguments to be returned.

- `getAoiArgs` - Asynchronously retrieves arguments related to AOI.

- `setStopping` - Set the stopping flag for the operation.
  - `stopping` - Flag indicating whether to stop the operation.

- `checkArgumentTypes` - Checks whether the provided arguments match the expected argument types for a function.
  - `argument` - Array of arguments to be checked.
  - `errorMessage` - Object to handle error messages.
  - `expectedArgumentTypes` - Array of expected argument types
  - Types available for checking: `number`, `object`, `string`, `nan`, `undefined`, `null`, `unknown`, `boolean`. 

#### Example
```js
client.addFunction({
  name: "$log",
  callback: async (ctx, dataEvent, database, error) => {
    ctx.argsCheck(1, error);
    const evaluate = await ctx.getEvaluateArgs();
    ctx.checkArgumentTypes(evaluate, error, ["string | number | boolean"]);
    console.log(...evaluate);
    return undefined;
  }
});
```
```js
client.addFunction({
  name: "$log",
  callback: async (ctx, dataEvent, database, error) => {
    ctx.argsCheck(1, error);
    const args = await ctx.getArgs(1, 2);
    const evaluate = await ctx.evaluateArgs(args);
    ctx.checkArgumentTypes(evaluate, error, ["string | number | boolean"]);
    console.log(...evaluate);
    return undefined;
  }
});
```
```js
client.addFunction({
  name: "$onlyArgsType",
  callback: async (ctx, dataEvent, database, error) => {
    ctx.argsCheck(2, error);
    const evaluate = await ctx.getEvaluateArgs();
    ctx.checkArgumentTypes(evaluate, error, ["...number"]);
    let text = "";
    evaluate.forEach((elem) => text += `${elem}\n`);
    return text;
  }
});
```
```js
client.addFunction({
  name: "$log",
  callback: async (ctx, dataEvent, database, error) => {
    ctx.argsCheck(1, error);
    const evaluate = await ctx.getAoiArgs();
    ctx.checkArgumentTypes(evaluate.splits, error, ["string | number | boolean"]);
    console.log(evaluate.inside);
    // or
    console.log(evaluate.toString());
    return undefined;
  }
});
```
```js
client.addFunction({
  name: "$stopping",
  callback: async (ctx, dataEvent, database, error) => {
    const evaluate = await ctx.getAoiArgs();
    const args = evaluate.splits?.[0] || true;
    if (args) ctx.setStopping(true);
    else ctx.setStopping(false);
  }
});
```

## database

These are all the methods available from [@aoitelegram/database](https://www.npmjs.com/package/@aoitelegram/database).

## error

- `errorArgs` - Sends an error message for a function with an incorrect argument count.

  - `amount` - The expected number of arguments.
  - `parameterCount` - The actual number of arguments provided.
  - `func` - The name of the function generating the error.
  - `line` - Line number of the error.

- `errorVar` - Sends an error message for an invalid variable.

  - `nameVar` - The name of the invalid variable.
  - `func` - The name of the function generating the error.

- `errorTable` - Sends an error message for an invalid table.
  - `table` - The name of the invalid table.
  - `func` - The name of the function generating the error.

- `errorArray` - Create and send an error message for an array-related error.
  - `name` - The name of the variable that does not exist.
  - `func` - The name of the function causing the error.

- `customError` - Creates a custom error with a specific description and function name.
  - `description` - Custom description of the error.
  - `func` - The name of the function where the error occurred.
  - `line` - Line number of the error.

```js
client.addFunction({
  name: "$error",
  callback: async (ctx, dataEvent, database, error) => {
    const target = ctx.target;
    const args = await ctx.getEvaluateArgs();
    ctx.checkArgumentTypes(args, error, ["string | undefined"]);
    error.customError(args[1] ?? "default error", target.value, target.line);
    return undefined;
  }
});
```

If you want to remove a function, there is a method called `<AoiClient>.removeFunction(func: string | string[])`.

## Function aoitelegram

**In development**
